[swap](https://segmentfault.com/a/1190000008125116)

swap space是磁盘上的一块区域，可以是一个分区，也可以是一个文件，或者是他们的组合。简单点说，当系统物理内存吃紧时，Linux会将内存中不常访问的数据保存到swap上，这样系统就有更多的物理内存为各个进程服务，而当系统需要访问swap上存储的内容时，再将swap上的数据加载到内存中，这就是我们常说的swap out和swap in。

## 为什么
- 对于一些大型的应用程序(如LibreOffice、video editor等)，在启动的过程中会使用大量的内存，但这些内存很多时候只是在启动的时候用一下，后面的运行过程中很少再用到这些内存。有了swap后，系统就可以将这部分不这么使用的内存数据保存到swap上去，从而释放出更多的物理内存供系统使用。
- 很多发行版(如ubuntu)的休眠功能依赖于swap分区，当系统休眠的时候，会将内存中的数据保存到swap分区上，等下次系统启动的时候，再将数据加载到内存中，这样可以加快系统的启动速度，所以如果要使用休眠的功能，必须要配置swap分区，并且大小一定要大于等于物理内存
- 在某些情况下，物理内存有限，但又想运行耗内存的程序怎么办？这时可以通过配置足够的swap空间来达到目标，虽然慢一点，但至少可以运行。
- 虽然大部分情况下，物理内存都是够用的，但是总有一些意想不到的状况，比如某个进程需要的内存超过了预期，或者有进程存在内存泄漏等，当内存不够的时候，就会触发内核的OOM killer，根据OOM killer的配置，某些进程会被kill掉或者系统直接重启（默认情况是优先kill耗内存最多的那个进程），不过有了swap后，可以拿swap当内存用，虽然速度慢了点，但至少给了我们一个去debug、kill进程或者保存当前工作进度的机会。
- 如果看过Linux内存管理，就会知道系统会尽可能多的将空闲内存用于cache，以加快系统的I/O速度，所以如果能将不怎么常用的内存数据移动到swap上，就会有更多的物理内存用于cache，从而提高系统整体性能。

## 缺点
swap是存放在磁盘上的，磁盘的速度和内存比较起来慢了好几个数量级，如果不停的读写swap，那么对系统的性能肯定有影响，尤其是当系统内存很吃紧的时候，读写swap空间发生的频率会很高，导致系统运行很慢，像死了一样，这个时候添加物理内存是唯一的解决办法。
> 由于系统会自动将不常用的内存数据移到swap上，对桌面程序来说，有可能会导致最小化一个程序后，再打开时小卡一下，因为需要将swap上的数据重新加载到内存中来。

## 到底要不要swap
### 内存不够用
不管是桌面还是服务器，当物理内存明显不够用，而又想跑程序的话，添加swap是唯一的选择，慢点总比不能工作强。

### 内存勉强够用
建议配置swap，这样内核会将不常用的数据从内存移到swap上，从而有更多的物理内存供系统调用，提升系统性能，同时也避免因偶尔的物理内存不够造成进程异常退出，提升系统稳定性，但对服务器来说，一定要限制或者监控swap空间的使用情况，当出现swap空间使用超预期或者swap in/out频繁时，要及时采取措施，不然对性能影响很大

### 内存充裕
理论上来说，如果物理内存足够多并且不需要休眠功能，那swap就没什么用，可关键问题是我们很难保证物理内存在任何情况下都够用，因为总有意想不到的情况发生，比如某些进程耗内存超预期，服务器压力超预期，内存泄漏等。

### 服务器环境
服务器一般都会配置监控程序，当内存用量达到一个阈值的时候告警或者会自动重启异常的进程。但如果没有监控呢？当内存被用光的时候，分两种情况：

- 配置了swap：这时服务器还能提供服务，但性能会降低好几个档次，直到最终处于几乎死机状态，并且这一过程将持续很长一段时间，对服务器来说是个灾难；所以配置swap只能让服务再苟延残喘一会儿，然后就是长时间的服务中断(比如原来是每秒处理1000个请求的服务器，由于频繁使用swap，导致现在每秒只能处理50个请求，站在系统角度，进程还在运行，但是在业务角度服务已经几乎中断了)。
- 没配置swap：这时内核的OOM killer被触发，在默认配置下，耗内存的进程会被优先kill掉，这种进程一般就是我们的业务进程，这时守护进程就会自动重启该业务进程(没有守护进程？开什么玩笑)，这种情况只会造成服务中断一会会儿(取决于进程重启的时间)，不会出现上面因配置了swap而导致性能很差且服务持续中断的情况。就算OOM killer没有kill掉预期的进程，我们通过测试也能发现，然后将OOM killer配置成重启系统，那也比配置了swap在那里苟延残喘的好。

从上面可以看出，对服务器来说，似乎不配置swap更好，可以让有问题的进程尽快重启，缩短业务受影响的时间。

并且，就算没有配置监控程序，我们还有cgroups中的内存控制模块，可以控制一组进程所能使用的最大内存数，当超过这个数的时候，可以触发相应的行为，比如重启进程等。

> 总的来说，对于桌面环境来说，一般内存没有服务器端那么充裕，并且由于使用场景原因，会打开很多不同类型的GUI窗口，但前台的进程只有一个，大部分都是在后台待命，所以配置swap对提升性能还是有必要的；对于服务器来说，配置的内存都比较充裕，启动起来的进程也都是要干活的进程(不然就不应该被启动起来)，并且也没有休眠的需求，再加上有了cgroups之后，可以更轻松的限制进程的内存使用，个人认为配置swap基本没什么必要了，看看coreos，默认就没有swap。

## swap查询操作
**通常配置内存大小的2倍即可，如果实在不够用，可以酌情增加一些**
```cassandraql
$ swapon -s #查看系统swap
$ vmstat 2 #参数2表示每两秒统计一次，si和so两列就是每秒swap in和out的次数
```

## 优化swap
- 尽量使用swap分区，相对于swap文件来说，分区肯定是连续的物理磁盘空间，而swap文件有可能不是
- 将swap分区和系统所在的分区放在不同的磁盘上，这样就不会和系统盘抢同一个磁盘的I/O带宽
- 如果有多块磁盘的话，可以在每个盘上创建一个swap分区，并且将它们的优先级设置的一样，这样内核就会平均的访问这些swap分区，性能相当于原来的N倍(这里N是磁盘的数量)