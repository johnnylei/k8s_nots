[原文地址](https://segmentfault.com/a/1190000008322093)

## 命令
- top
- iotop

## 关键指标
- load average
- us: 用户态
- sy: 内核态
- ni: 
- id: 空闲
- wa: i/o等待
- hi or si : 这两个值反映了CPU有多少时间花在了中断处理上，hi（hardware interrupts）是硬件中断，si(softirqs)是软件中断。
- st: %st和虚拟机有关

## load average
```cassandraql
top - 01:06:49 up 1 day, 13:20,  2 users,  load average: 0.04, 0.02, 0.00
Tasks: 152 total,   1 running, 151 sleeping,   0 stopped,   0 zombie
%Cpu(s):  0.3 us,  0.3 sy,  0.0 ni, 99.3 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st
KiB Mem:   2029916 total,   756120 used,  1273796 free,    64908 buffers
KiB Swap:  2093052 total,        0 used,  2093052 free.   507664 cached Mem
```
load average: 0.00, 0.03, 0.00分别表示当前CPU在1分钟、5分钟和15分钟内的平均负载

源自文件: `/proc/loadavg`

这里以单核CPU为例
- 小于1： 说明平均每次只有不到一个job在忙，对于单核的CPU来说，完全能处理过来
- 等于1： 说明平均每次刚好有一个job在忙，对于单核的CPU来说，刚好能处理过来
- 大于1： 说明平均每次有多于一个job在忙，对于单核的CPU来说，由于一次只能处理一个任务，所以肯定有任务在等待，说明系统负载较大，调度不过来，有job需要等待

**建议控制在“0.7*核数”以内，比如4核，那么0.7*4=2.8比较合适**

## cpus
> CPU会处于下面三种状态中的一种：
- Idle： 处于空闲状态，没有任务需要调度
- User space： 正在运行user space的代码（处于用户态）
- Kernel： 正在运行内核的代码（处于内核态）

## 问题处理
- %us过高 ： 表示有用户态进程占用了过多的CPU，通过top命令可以很清楚的看到是哪个进程，如果这不是预期的行为，可以通过kill命令杀死相应的进程或者重启它
- %sy过高 ： 如果只是偶尔过高的话，不用担心，但如果是持续走高的话，就需要重视，有可能是某些进程的系统调用太频繁，比如进程不停的往控制台输出日志，但如果用户态的进程都没有问题，那可能是内核里面的代码出现了问题，尤其是代码写的不好的驱动模块
- %ni过高 ： 说明有人用nice程序运行了比较耗CPU的进程。如果niceness值大于0的话，就没什么好担心的，因为它的优先级比默认优先级要低，不会影响CPU性能，但最好还是确认一下该进程不会抢占系统的其它资源，如内存、磁盘I/O等，避免对系统整体性能造成影响。如果niceness值小于0的话，表示该进程优先级高且占用CPU资源多，需要确保该进程占用的CPU资源是符合预期的，如果不是，可以用top命令把它找出来并kill掉或者重启。
- %wa过高 ： 意味着系统中有进程在做大量的I/O操作，或者在读写速度比较慢的I/O设备，比如频繁的读写磁盘，这时可以通过iotop命令来查看是哪些进程占I/O，然后再针对不同的进程做相应的处理；还有一种情况就是系统在频繁的使用交换分区，这时需要解决的就是内存的问题，而不是I/O的问题。
- %hi或者%si过高 ： %hi过高一般是硬件出问题了，%si过高一般是内核里面的代码出问题了
- %st 过高 ： 正如上面介绍介绍的那样，%st过高表示当前虚拟机得不到足够的CPU资源。这时可以考虑将当前虚拟机搬迁到其它的主机上，或者想办法降低当前主机的负载，比如关掉一些其它的虚拟机。

## 结束语
load average和%Cpu(s)以不同的方式给出了当前主机的CPU负载情况，通过%Cpu(s)我们可以看到系统当前的实时负载，现在很多监控系统每隔一段时间都会采集一次%Cpu(s)，然后存储起来以图形的方式展示出来，这样就能很直观的看到CPU负载的变化，当然如果没有这样的监控系统的话，通过load average也能大概的知道最近一段时间内的平均负载（最长15分钟）。