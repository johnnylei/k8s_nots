[内存管理](https://segmentfault.com/a/1190000008125006)
[内存使用情况](https://segmentfault.com/a/1190000008125059)
[swap](https://segmentfault.com/a/1190000008125116)

在linux下，使用top，vmstat,free等命令查看系统或者进程的内存使用情况时，经常看到buff/cache memeory，swap，avail Mem等，他们都代表什么意思呢？这篇文章将来聊一聊Linux下的内存管理并解答这个问题。

## 虚拟内存
虚拟内存是Linux管理内存的一种技术。它使得每个应用程序都认为自己拥有独立且连续的可用的内存空间（一段连续完整的地址空间），而实际上，它通常是被映射到多个物理内存段，还有部分暂时存储在外部磁盘存储器上，在需要时再加载到内存中来。

每个进程所能使用的虚拟地址大小和CPU位数有关，在32位的系统上，虚拟地址空间大小是4G，在64位系统上，是2^64=？（算不过来了）。而实际的物理内存可能远远小于虚拟地址空间的大小。

虚拟地址和进程息息相关，不同进程里的同一个虚拟地址指向的物理地址不一定一样，所以离开进程谈虚拟地址没有任何意义。

```cassandraql
  进程X                                                                      进程Y
+-------+                                                                  +-------+
| VPFN7 |--+                                                               | VPFN7 |
+-------+  |       进程X的                                 进程Y的           +-------+
| VPFN6 |  |      Page Table                              Page Table     +-| VPFN6 |
+-------+  |      +------+                                +------+       | +-------+
| VPFN5 |  +----->| .... |---+                    +-------| .... |<---+  | | VPFN5 |
+-------+         +------+   |        +------+    |       +------+    |  | +-------+
| VPFN4 |    +--->| .... |---+-+      | PFN4 |    |       | .... |    |  | | VPFN4 |
+-------+    |    +------+   | |      +------+    |       +------+    |  | +-------+
| VPFN3 |--+ |    | .... |   | | +--->| PFN3 |<---+  +----| .... |<---+--+ | VPFN3 |
+-------+  | |    +------+   | | |    +------+       |    +------+    |    +-------+
| VPFN2 |  +-+--->| .... |---+-+-+    | PFN2 |<------+    | .... |    |    | VPFN2 |
+-------+    |    +------+   | |      +------+            +------+    |    +-------+
| VPFN1 |    |               | +----->| FPN1 |                        +----| VPFN1 |
+-------+    |               |        +------+                             +-------+
| VPFN0 |----+               +------->| PFN0 |                             | VPFN0 |
+-------+                             +------+                             +-------+
 虚拟内存                               物理内存                               虚拟内存


PFN(the page frame number)： 页编号
```
当进程执行一个程序时，需要先从先内存中读取该进程的指令，然后执行，获取指令时用到的就是虚拟地址，这个地址是程序链接时确定的（内核加载并初始化进程时会调整动态库的地址范围），为了获取到实际的数据，CPU需要将虚拟地址转换成物理地址，CPU转换地址时需要用到进程的page table，而page table里面的数据由操作系统维护。

> 注意：Linux内核代码访问内存时用的都是实际的物理地址，所以不存在虚拟地址到物理地址的转换，只有应用层程序才需要。

### 虚拟内存优点
- 更大的地址空间：并且是连续的，使得程序编写、链接更加简单
- 进程隔离：不同进程的虚拟地址之间没有关系，所以一个进程的操作不会对其它进程造成影响
- 数据保护：每块虚拟内存都有相应的读写属性，这样就能保护程序的代码段不被修改，数据块不能被执行等，增加了系统的安全性
- 内存映射：有了虚拟内存之后，可以直接映射磁盘上的文件（可执行文件或动态库）到虚拟地址空间，这样可以做到物理内存延时分配，只有在需要读相应的文件的时候，才将它真正的从磁盘上加载到内存中来，而在内存吃紧的时候又可以将这部分内存清空掉，提高物理内存利用效率，并且所有这些对应用程序来说是都透明的
- 共享内存：比如动态库，只要在内存中存储一份就可以了，然后将它映射到不同进程的虚拟地址空间中，让进程觉得自己独占了这个文件。进程间的内存共享也可以通过映射同一块物理内存到进程的不同虚拟地址空间来实现共享
- 物理内存管理：物理地址空间全部由操作系统管理，进程无法直接分配和回收，从而系统可以更好的利用内存，平衡进程间对内存的需求
- 其它：有了虚拟地址空间后，交换空间和COW（copy on write）等功能都能很方便的实现

### pagetable
page table可以简单的理解为一个memory mapping的链表（当然实际结构很复杂），里面的每个memory mapping都将一块虚拟地址映射到一个特定的资源（物理内存或者外部存储空间）。每个进程拥有自己的page table，和其它进程的page table没有关系。

### 内存使用情况
#### top
```cassandraql
  PID USER      PR  NI    VIRT    RES    SHR S %CPU %MEM     TIME+ COMMAND
 2530 root      20   0       0      0      0 S  0.3  0.0   0:02.69 kworker/0:0
 2714 dev       20   0   41824   3700   3084 R  0.3  0.7   0:00.02 top
 3008 dev       20   0   22464   5124   3356 S  0.0  1.0   0:00.02 bash
```
VIRT：进程所使用的虚拟内存大小

RES：系统为虚拟内存分配的物理内存大小，包括file backed和anonymous内存，其中anonymous包含了进程自己分配和使用的内存，以及和别的进程通过mmap共享的内存；而file backed的内存就是指加载可执行文件和动态库所占的内存，以及通过private方式调用mmap映射文件所使用的内存（当在内存中修改了这部分数据且没有写回文件，那么这部分内存就变成了anonymous），这部分内存也可能跟别的进程共享。

SHR：RES的一部分，表示和别的进程共享的内存，包括通过mmap共享的内存和file backed的内存。当通过prive方式调用mmap映射一个文件时，如果没有修改文件的内容，那么那部分内容就是SHR的，一旦修改了文件内容且没有写回文件，那么这部分内存就是anonymous且非SHR的。

%MEM：等于RES/total*100%，这里total指总的物理内存大小。

> 注意：由于SHR可能会被多个进程所共享，所以系统中所有进程的RES加起来可能会超过总的物理内存数量，由于同样的原因，所有进程的%MEM总和可能超过100%。

> 从上面的分析可以看出，VIRT的参考意义不大，它只能反应出程序的大小，而RES也不能完全的代表一个进程真正占用的内存空间，因为它里面还包含了SHR的部分，比如三个bash进程共享了一个libc动态库，那么libc所占用的内存算谁的呢？三个进程平分吗？如果启动一个bash占用了4M的RES，其中3M是libc占用的，由于三个进程都共享那3M的libc，那么启动3个bash实际占用的内存将是3*(4-3)+3=6M，但是如果单纯的按照RES来算的话，三个进程就用了12M的空间。所以理解RES和SHR这两个数据的含义对我们在评估一台服务器能跑多少个进程时尤其重要，不要一看到apache的进程占用了20M，就认为系统能跑的apache进程数就是总的物理内存数除以20M，其实这20M里面有可能有很大一部分是SHR的。

#### pmap
上面top命令只是给出了一个进程大概占用了多少的内存，而pmap能更详细的给出内存都是被谁占用了。pmap命令输出的内容来自于/proc/[pid]/maps和/proc/[pid]/smaps这两个文件，第一个文件包含了每段的一个大概描述，而后一个文件包含了更详细的信息。

```cassandraql
# pmap $$
1962:   bash
0000000000400000    960K r-x-- bash
00000000006ef000      4K r---- bash
00000000006f0000     36K rw--- bash
00000000006f9000     24K rw---   [ anon ]
0000000000d2b000    440K rw---   [ anon ]
00007f458b62d000     40K r-x-- libnss_files-2.19.so
00007f458b637000   2044K ----- libnss_files-2.19.so
00007f458b836000      4K r---- libnss_files-2.19.so
00007f458b837000      4K rw--- libnss_files-2.19.so
00007f458b838000     44K r-x-- libnss_nis-2.19.so
00007f458b843000   2044K ----- libnss_nis-2.19.so
00007f458ba42000      4K r---- libnss_nis-2.19.so
00007f458ba43000      4K rw--- libnss_nis-2.19.so
00007f458ba44000     92K r-x-- libnsl-2.19.so
00007f458ba5b000   2044K ----- libnsl-2.19.so
00007f458bc5a000      4K r---- libnsl-2.19.so
00007f458bc5b000      4K rw--- libnsl-2.19.so
00007f458bc5c000      8K rw---   [ anon ]
00007f458bc5e000     36K r-x-- libnss_compat-2.19.so
00007f458bc67000   2044K ----- libnss_compat-2.19.so
00007f458be66000      4K r---- libnss_compat-2.19.so
00007f458be67000      4K rw--- libnss_compat-2.19.so
00007f458be68000   2852K r---- locale-archive
00007f458c131000   1784K r-x-- libc-2.19.so
00007f458c2ef000   2048K ----- libc-2.19.so
00007f458c4ef000     16K r---- libc-2.19.so
00007f458c4f3000      8K rw--- libc-2.19.so
00007f458c4f5000     20K rw---   [ anon ]
00007f458c4fa000     12K r-x-- libdl-2.19.so
00007f458c4fd000   2044K ----- libdl-2.19.so
00007f458c6fc000      4K r---- libdl-2.19.so
00007f458c6fd000      4K rw--- libdl-2.19.so
00007f458c6fe000    148K r-x-- libtinfo.so.5.9
00007f458c723000   2044K ----- libtinfo.so.5.9
00007f458c922000     16K r---- libtinfo.so.5.9
00007f458c926000      4K rw--- libtinfo.so.5.9
00007f458c927000    140K r-x-- ld-2.19.so
00007f458cb3d000     16K rw---   [ anon ]
00007f458cb42000     28K r--s- gconv-modules.cache
00007f458cb49000      4K r---- ld-2.19.so
00007f458cb4a000      4K rw--- ld-2.19.so
00007f458cb4b000      4K rw---   [ anon ]
00007ffcfa694000    132K rw---   [ stack ]
00007ffcfa77c000      8K r-x--   [ anon ]
ffffffffff600000      4K r-x--   [ anon ]
 total            21236K
```

这里第一列是内存的起始地址，第二列是mapping的地址大小，第三列是这段内存的访问权限，最后一列是mapping到的文件。这里的地址都是虚拟地址，大小也是虚拟地址大小。

这里的输出有很多的[ anon ]行，表示在磁盘上没有对应的文件，这些一般都是可执行文件或者动态库里的bss段。当然有对应文件的mapping也有可能是anonymous，比如文件的数据段。关于程序的数据段和bss段的介绍请参考elf的相关资料。

上面可以看到bash、libc-2.23.so等文件出现了多行，但每行的权限不一样，这是因为每个动态库或者可执行文件里面都分很多段，有只能读和执行的代码段，有能读写的数据段，还有比如这一行“00007f1fa153b000 16K rw--- [ anon ]”，就是它上面一行libc-2.23.so的bss段。

[ stack ]表示进程用到的栈空间，而heap在这里看不到，因为pmap默认情况下不单独标记heap出来，由于heap是anonymous，所以从这里的大小可以推测出来，heap就是“0000000000be4000 1544K rw--- [ anon ]”。

查看物理内存使用情况
```cassandraql
# pmap -X $$
1962:   bash
         Address Perm   Offset Device  Inode  Size  Rss Pss Referenced Anonymous Swap Locked Mapping
        00400000 r-xp 00000000  fc:00 786434   960  636 211        636         0    0      0 bash
        006ef000 r--p 000ef000  fc:00 786434     4    4   4          4         4    0      0 bash
        006f0000 rw-p 000f0000  fc:00 786434    36   36  36         36        36    0      0 bash
        006f9000 rw-p 00000000  00:00      0    24   24  24         24        24    0      0 
        00d2b000 rw-p 00000000  00:00      0   440  436 436        436       436    0      0 [heap]
    7f458b62d000 r-xp 00000000  fc:00 403803    40   12   0         12         0    0      0 libnss_files-2.19.so
    7f458b637000 ---p 0000a000  fc:00 403803  2044    0   0          0         0    0      0 libnss_files-2.19.so
    7f458b836000 r--p 00009000  fc:00 403803     4    4   4          4         4    0      0 libnss_files-2.19.so
    7f458b837000 rw-p 0000a000  fc:00 403803     4    4   4          4         4    0      0 libnss_files-2.19.so
    7f458b838000 r-xp 00000000  fc:00 403791    44   12   0         12         0    0      0 libnss_nis-2.19.so
    7f458b843000 ---p 0000b000  fc:00 403791  2044    0   0          0         0    0      0 libnss_nis-2.19.so
    7f458ba42000 r--p 0000a000  fc:00 403791     4    4   4          4         4    0      0 libnss_nis-2.19.so
    7f458ba43000 rw-p 0000b000  fc:00 403791     4    4   4          4         4    0      0 libnss_nis-2.19.so
    7f458ba44000 r-xp 00000000  fc:00 403807    92   20   1         20         0    0      0 libnsl-2.19.so
    7f458ba5b000 ---p 00017000  fc:00 403807  2044    0   0          0         0    0      0 libnsl-2.19.so
    7f458bc5a000 r--p 00016000  fc:00 403807     4    4   4          4         4    0      0 libnsl-2.19.so
    7f458bc5b000 rw-p 00017000  fc:00 403807     4    4   4          4         4    0      0 libnsl-2.19.so
    7f458bc5c000 rw-p 00000000  00:00      0     8    0   0          0         0    0      0 
    7f458bc5e000 r-xp 00000000  fc:00 403806    36   24   1         24         0    0      0 libnss_compat-2.19.so
    7f458bc67000 ---p 00009000  fc:00 403806  2044    0   0          0         0    0      0 libnss_compat-2.19.so
    7f458be66000 r--p 00008000  fc:00 403806     4    4   4          4         4    0      0 libnss_compat-2.19.so
    7f458be67000 rw-p 00009000  fc:00 403806     4    4   4          4         4    0      0 libnss_compat-2.19.so
    7f458be68000 r--p 00000000  fc:00 661129  2852   56  11         56         0    0      0 locale-archive
    7f458c131000 r-xp 00000000  fc:00 403802  1784  600  42        600         0    0      0 libc-2.19.so
    7f458c2ef000 ---p 001be000  fc:00 403802  2048    0   0          0         0    0      0 libc-2.19.so
    7f458c4ef000 r--p 001be000  fc:00 403802    16   16  16         16        16    0      0 libc-2.19.so
    7f458c4f3000 rw-p 001c2000  fc:00 403802     8    8   8          8         8    0      0 libc-2.19.so
    7f458c4f5000 rw-p 00000000  00:00      0    20   16  16         16        16    0      0 
    7f458c4fa000 r-xp 00000000  fc:00 403793    12    8   0          8         0    0      0 libdl-2.19.so
    7f458c4fd000 ---p 00003000  fc:00 403793  2044    0   0          0         0    0      0 libdl-2.19.so
    7f458c6fc000 r--p 00002000  fc:00 403793     4    4   4          4         4    0      0 libdl-2.19.so
    7f458c6fd000 rw-p 00003000  fc:00 403793     4    4   4          4         4    0      0 libdl-2.19.so
    7f458c6fe000 r-xp 00000000  fc:00 393497   148  120  39        120         0    0      0 libtinfo.so.5.9
    7f458c723000 ---p 00025000  fc:00 393497  2044    0   0          0         0    0      0 libtinfo.so.5.9
    7f458c922000 r--p 00024000  fc:00 393497    16   16  16         16        16    0      0 libtinfo.so.5.9
    7f458c926000 rw-p 00028000  fc:00 393497     4    4   4          4         4    0      0 libtinfo.so.5.9
    7f458c927000 r-xp 00000000  fc:00 403799   140  120   6        120         0    0      0 ld-2.19.so
    7f458cb3d000 rw-p 00000000  00:00      0    16   16  16         16        16    0      0 
    7f458cb42000 r--s 00000000  fc:00 668604    28   24   4         24         0    0      0 gconv-modules.cache
    7f458cb49000 r--p 00022000  fc:00 403799     4    4   4          4         4    0      0 ld-2.19.so
    7f458cb4a000 rw-p 00023000  fc:00 403799     4    4   4          4         4    0      0 ld-2.19.so
    7f458cb4b000 rw-p 00000000  00:00      0     4    4   4          4         4    0      0 
    7ffcfa694000 rw-p 00000000  00:00      0   136   24  24         24        24    0      0 [stack]
    7ffcfa77c000 r-xp 00000000  00:00      0     8    4   0          4         0    0      0 [vdso]
ffffffffff600000 r-xp 00000000  00:00      0     4    0   0          0         0    0      0 [vsyscall]
                                             ===== ==== === ========== ========= ==== ====== 
                                             21240 2288 967       2288       652    0      0 KB
```

- 权限字段多了一个s和p的标记，s表示是和别人共享的内存空间，读写会影响到其他进程，而p表示这是自己私有的内存空间，读写这部分内存不会对其他进程造成影响。
- RSS列表示实际占用的物理内存大小
- Anonymous列标示出了哪些是并且有多少是Anonymous方式映射的物理内存，其大小小于等于RSS
- 输出标示出了[heap]段，并且也说明了后面几个[anon]代表的什么意思（vvar，vdso，vsyscall都是映射到内核的特殊段），mapping字段为空的都是上一行mapping文件里面的bss段（可是gconv-modules.cache后面有两行anonymous mapping，可能跟共享内存有关系，没有深究）。

#### top命令输出的SHR内存
```cassandraql
dev@dev:~$ pmap -d $$
3108:   bash
Address           Kbytes Mode  Offset           Device    Mapping
0000000000400000     976 r-x-- 0000000000000000 0fc:00000 bash
00000000006f3000       4 r---- 00000000000f3000 0fc:00000 bash
00000000006f4000      36 rw--- 00000000000f4000 0fc:00000 bash
00000000006fd000      24 rw--- 0000000000000000 000:00000   [ anon ]
0000000000c23000    1544 rw--- 0000000000000000 000:00000   [ anon ]
......
00007f53af18e000      16 rw--- 0000000000000000 000:00000   [ anon ]
00007f53af198000       8 rw--- 0000000000000000 000:00000   [ anon ]
00007f53af19a000       4 r---- 0000000000025000 0fc:00000 ld-2.23.so
00007f53af19b000       4 rw--- 0000000000026000 0fc:00000 ld-2.23.so
00007f53af19c000       4 rw--- 0000000000000000 000:00000   [ anon ]
00007ffc5a94b000     132 rw--- 0000000000000000 000:00000   [ stack ]
00007ffc5a9b7000       8 r---- 0000000000000000 000:00000   [ anon ]
00007ffc5a9b9000       8 r-x-- 0000000000000000 000:00000   [ anon ]
ffffffffff600000       4 r-x-- 0000000000000000 000:00000   [ anon ]
mapped: 22464K    writeable/private: 1848K    shared: 28K

dev@dev:~$ top -p $$
  PID USER      PR  NI    VIRT    RES    SHR S %CPU %MEM     TIME+ COMMAND
 3108 dev       20   0   22464   5028   3264 S  0.0  1.0   0:00.02 bash
```
从上面的输出可看出SHR ≈ RES - writeable/private，其中writeable/private主要包含stack和heap以及可执行文件和动态库的data和bss段，而stack+heap=1544+132=1675，这已经占了绝大部分，从而data和bss段之类的基本上可以忽略了，所以一般情况下，SHR ≈ RES - [heap] - [stack]，由于stack一般都比较小，上面的等式可以进一步约等于：SHR ≈ RES - [heap]。

#### 小结
top命令能看到一个进程占用的虚拟内存空间、物理内存空间以及和别的进程共享的物理内存空间，这里共享的空间包括通过mmap共享的内存以及共享的可执行文件以及动态库。而mmap命令能看到更详细的信息，比如可执行文件和它所链接的动态库大小，以及物理内存都是被哪些段给占用了。

进程占用的虚拟地址空间大小跟程序的规模有关，除了stack和heap段，其他段的大小基本上都是固定的，并且在程序链接的时候就已经确定了，所以基本上只要关注stack和heap段就可以了，由于stack相对heap来说很小，所以只要没什么stack异常，只需要关注heap。

在实际的工作过程中，其实我们更关心的是RSS用了多少，都被谁用了，简单点说，如果我们没有同时启动多个进程（同一个程序），RSS就是一个很好的实际物理内存使用参考值，但如果是像apache那样同时跑很多个进程，那么RSS减去SHR所占用的空间就是一个很好的实际物理内存占用参考值，当然这都是大概估算值。

要想精确评估一个进程到底占了多少内存，还是很难的，需要对进程的每个段有深入的理解，尤其是SHR部分都有哪些进程在一起共享，不过现在服务器上的内存都是以G为单位的，所以一般情况下大概的估算一下加上合理的测试就能满足我们的需求了。

```cassandraql
$ top
$ top -p $$ #指定进程， 虚拟，物理，共享内存
$ pmap $$ #查看进程使用的虚拟内存
$ pmap -X $$ #查看进程使用的物理内存(RSS)
$ pamp -d $$ #查看进程内存情况
```